import{readFileSync as e,readdirSync as r,statSync as t,existsSync as o}from"fs";import{join as n,resolve as a}from"path";import i from"gray-matter";export default class l{static generateSidebar(e){const r={},t=Array.isArray(e);let o,a,i=!1;if(arguments.length>1)throw new Error("You must pass 1 argument, see the documentation for details.");o=void 0===e?[{}]:Array.isArray(e)?e:[e];for(let e=0;e<o.length;e+=1){const t=o[e];if(t.root)throw new Error(l.generateDeprecateMessage("root","documentRootPath"));if(t.withIndex)throw new Error(l.generateDeprecateMessage("withIndex","includeRootIndexFile"));if(t.includeEmptyGroup)throw new Error(l.generateDeprecateMessage("includeEmptyGroup","includeEmptyFolder"));if(t.sortByFileName)throw new Error(l.generateDeprecateMessage("sortByFileName","manualSortFileNameByPriority"));if(t.useFolderLinkAsIndexPage)throw new Error(l.generateDeprecateMessage("useFolderLinkAsIndexPage","useIndexFileForFolderMenuInfo"));if(t.excludeFilesByFrontmatter)throw new Error(l.generateDeprecateMessage("excludeFilesByFrontmatter","excludeFilesByFrontmatterFieldName"));if(t.useIndexFileForFolderMenuInfo)throw new Error(l.generateDeprecateMessage("useIndexFileForFolderMenuInfo","useFolderTitleFromIndexFile` and `useFolderLinkFromIndexFile"));if(t.sortMenusOrderNumerically)throw new Error(l.generateDeprecateMessage("sortMenusOrderNumerically","sortMenusOrderNumericallyFromTitle` and `sortMenusOrderNumericallyFromLink"));if(l.isTrueMinimumNumberOfTimes([t.sortMenusByFrontmatterOrder,t.sortMenusByName,t.sortMenusByFileDatePrefix],2))throw new Error(l.generateNotTogetherMessage(["sortMenusByFrontmatterOrder","sortMenusByName","sortMenusByFileDatePrefix"]));if(l.isTrueMinimumNumberOfTimes([t.sortMenusByFrontmatterOrder,t.sortMenusOrderNumericallyFromTitle,t.sortMenusOrderNumericallyFromLink],2))throw new Error(l.generateNotTogetherMessage(["sortMenusByFrontmatterOrder","sortMenusOrderNumericallyFromTitle","sortMenusOrderNumericallyFromLink"]));if(l.isTrueMinimumNumberOfTimes([t.sortMenusByFrontmatterOrder,t.sortMenusByFrontmatterDate],2))throw new Error(l.generateNotTogetherMessage(["sortMenusByFrontmatterOrder","sortMenusByFrontmatterDate"]));if(t.removePrefixAfterOrdering&&!t.prefixSeparator)throw new Error("'prefixSeparator' should not use empty string");t.debugPrint&&!i&&(i=!0),t.documentRootPath=t?.documentRootPath??"/",/^\//.test(t.documentRootPath)||(t.documentRootPath=`/${t.documentRootPath}`),t.collapseDepth&&(t.collapsed=!0),t.prefixSeparator||(t.prefixSeparator="."),t.collapseDepth=t?.collapseDepth??1,t.manualSortFileNameByPriority=t?.manualSortFileNameByPriority??[],t.excludeFiles=t?.excludeFiles??[],t.excludeFolders=t?.excludeFolders??[],t.frontmatterOrderDefaultValue=t?.frontmatterOrderDefaultValue??0;let a=t.documentRootPath;t.scanStartPath&&(a=`${t.documentRootPath}/${t.scanStartPath}`.replace(/\/{2,}/g,"/").replace("/$",""));let s=l.generateSidebarItem(1,n(process.cwd(),a),a,null,t);t.removePrefixAfterOrdering&&(s=l.removePrefixFromTitleAndLink(s,t)),r[t.resolvePath||"/"]={base:t.basePath||t.resolvePath||"/",items:s?.items||(t.rootGroupText||t.rootGroupLink||!0===t.rootGroupCollapsed||!1===t.rootGroupCollapsed?[{text:t.rootGroupText,...t.rootGroupLink?{link:t.rootGroupLink}:{},items:s,...null===t.rootGroupCollapsed?{}:{collapsed:t.rootGroupCollapsed}}]:s)}}return a=t||1!==Object.keys(r).length?r:Object.values(r)[0].items,i&&process.stdout.write(`\n${"=".repeat(50)}\n${JSON.stringify(o,null,2)}\n${"-".repeat(50)}\n${JSON.stringify(a,null,2)}\n${"=".repeat(50)}\n\n`),a}static generateDeprecateMessage(e,r){return`The \`${e}\` option was renamed to \`${r}\`.`}static generateNotTogetherMessage(e){return`These options cannot be used together: ${e.join(", ")}`}static generateSidebarItem(e,n,i,s,u){let d=r(n);if(u.manualSortFileNameByPriority.length>0){const e=d.filter((e=>-1!==u.manualSortFileNameByPriority?.indexOf(e))),r=d.filter((e=>-1===u.manualSortFileNameByPriority?.indexOf(e)));e.sort(((e,r)=>u.manualSortFileNameByPriority.indexOf(e)-u.manualSortFileNameByPriority.indexOf(r))),d=[...e,...r]}let m=d.map((r=>{const d=a(n,r);let m=`${i}/${r}`.replace(/\/{2}/,"/").replace(/(index)?\.md$/,"");if(u.documentRootPath&&m.startsWith(u.documentRootPath)&&(m=m.replace(new RegExp(`^${u.documentRootPath}`,"g"),""),u.scanStartPath||u.resolvePath?(m=m.replace(/^\//g,""),u.scanStartPath&&(m=m.replace(new RegExp(`^${u.scanStartPath}`,"g"),"")),m=m.replace(/^\/(?!$)/g,""),"/"===m&&(m="index.md")):m.startsWith("/")||(m=`/${m}`)),/\.vitepress/.test(d))return null;if(/node_modules/.test(d))return null;if(1===e&&"index.md"===r&&!u.includeRootIndexFile)return null;if(1!==e&&"index.md"===r&&!u.includeFolderIndexFile)return null;if(!u.includeDotFiles&&/^\./.test(r))return null;if(t(d).isDirectory()){if(u.excludeFolders?.includes(r))return null;let t,n=l.generateSidebarItem(e+1,d,m,r,u)||[],i=l.getTitleFromMd(r,d,u,!0),s=d,c=!1;if(u.convertSameNameSubFileToGroupIndexPage){const e=n.find((e=>e.text===r));e&&(s=a(d,`${e.text}.md`),i=l.getTitleFromMd(r,s,u,!1),t=u.folderLinkNotIncludesFileName?`${m}/`:e.link,n=n.filter((e=>e.text!==r)))}else s=`${d}/index.md`,o(s)&&(c=!0,u.useFolderTitleFromIndexFile&&(i=l.getTitleFromMd("index",s,u)),u.useFolderLinkFromIndexFile&&(t=`${m}/index.md`));return t&&!1!==u.includeEmptyFolder||u.includeEmptyFolder||n.length>0||c?{text:i,...t?{link:t}:{},items:n,...null===u.collapsed||void 0===u.collapsed?{}:{collapsed:e>=u.collapseDepth&&u.collapsed},...u.sortMenusByFrontmatterOrder?{order:l.getOrderFromFrontmatter(s,u.frontmatterOrderDefaultValue)}:{},...u.sortMenusByFrontmatterDate?{date:l.getDateFromFrontmatter(d)}:{}}:null}if(d.endsWith(".md")){if(u.excludeFiles?.includes(r)||l.getExcludeFromFrontmatter(d,u.excludeFilesByFrontmatterFieldName))return null;let e;const t=r.replace(/\.md$/,"");return e=u.convertSameNameSubFileToGroupIndexPage&&s===t?t:l.getTitleFromMd(r,d,u),{text:e,link:m,...u.sortMenusByFrontmatterOrder?{order:l.getOrderFromFrontmatter(d,u.frontmatterOrderDefaultValue)}:{},...u.sortMenusByFrontmatterDate?{date:l.getDateFromFrontmatter(d)}:{}}}return null})).filter((e=>null!==e));return u.sortMenusByName&&(m=l.sortByObjectKey({arr:m,key:"text",desc:u.sortMenusOrderByDescending})),u.sortMenusByFileDatePrefix&&(m=l.sortByObjectKey({arr:m,key:"text",desc:u.sortMenusOrderByDescending,dateSortFromTextWithPrefix:!0,datePrefixSeparator:u.prefixSeparator})),u.sortMenusByFrontmatterOrder&&(m=l.sortByObjectKey({arr:m,key:"order",desc:u.sortMenusOrderByDescending}),l.deepDeleteKey(m,"order")),u.sortMenusByFrontmatterDate&&(m=l.sortByObjectKey({arr:m,key:"date",desc:u.sortMenusOrderByDescending,dateSortFromFrontmatter:!0}),l.deepDeleteKey(m,"date")),u.sortMenusOrderNumericallyFromTitle&&(m=l.sortByObjectKey({arr:m,key:"text",desc:u.sortMenusOrderByDescending,numerically:!0})),u.sortMenusOrderNumericallyFromLink&&(m=l.sortByObjectKey({arr:m,key:"link",desc:u.sortMenusOrderByDescending,numerically:!0})),m}static getValueFromFrontmatter(r,t,o){try{const o=e(r,"utf-8"),{data:n}=i(o);if(n?.[t])return n[t];const a=o.split("\n");let l=!1;for(let e=0,r=a.length;e<r;e+=1){const r=a[e].toString().replace("\r","");if(/^---$/.test(r)&&(l=!0),new RegExp(`^${t}: (.*)`).test(r)&&l)return JSON.parse(r.replace(`${t}: `,""))}}catch(e){return o}return o}static getOrderFromFrontmatter(e,r){return parseInt(l.getValueFromFrontmatter(e,"order",r.toString()),10)}static getDateFromFrontmatter(e){return l.getValueFromFrontmatter(e,"date","0001-01-01")}static getExcludeFromFrontmatter(e,r){return!!r&&l.getValueFromFrontmatter(e,r,!1)}static capitalizeFirst(e){return e.charAt(0).toUpperCase()+e.slice(1)}static formatTitle(e,r){let t=r;if(e.hyphenToSpace&&(t=t.replace(/-/g," ")),e.underscoreToSpace&&(t=t.replace(/_/g," ")),e.capitalizeEachWords){const e=t.trim().toLowerCase().split(" ");for(let r=0;r<e.length;r+=1)e[r]=l.capitalizeFirst(e[r]);t=e.join(" ")}else e.capitalizeFirst&&(t=l.capitalizeFirst(t));return t}static getTitleFromMd(r,t,o,n=!1){if(n)return l.formatTitle(o,r);if(o.useTitleFromFrontmatter){let e=l.getValueFromFrontmatter(t,o.frontmatterTitleFieldName||"title",void 0);if(e||(e=l.getValueFromFrontmatter(t,"title",void 0)),e)return l.formatTitle(o,e)}if(o.useTitleFromFileHeading)try{const r=e(t,"utf-8").split("\n");for(let e=0,t=r.length;e<t;e+=1){let t=r[e].toString().replace("\r","");if(/^# /.test(t)){if(t=t.replace(/^# /,""),/\[(.*)]\(.*\)/.test(t)){const e=/(.*)?\[(.*)]\((.*)\)(.*)?/.exec(t)||"";t=e.length>0?`${e[1]||""}${e[2]||""}${e[4]||""}`:""}return o.keepMarkdownSyntaxFromTitle||(t=t.replace(/\*{1,2}([^*]+?)\*{1,2}/g,"$1"),t=t.replace(/_{1,2}([^_]+?)_{1,2}/g,"$1"),t=t.replace(/~{1,2}([^~]+?)~{1,2}/g,"$1"),t=t.replace(/`{1,3}([^`]+?)`{1,3}/g,"$1")),l.formatTitle(o,t)}}}catch{return"Unknown"}return l.formatTitle(o,r.replace(/\.md$/,""))}static sortByObjectKey(e){for(let r=0;r<e.arr.length;r+=1)e.arr[r].items&&e.arr[r].items.length&&(e.arr[r].items=l.sortByObjectKey({...e,arr:e.arr[r].items}));if(e.numerically){const r=new Intl.Collator([],{numeric:!0}),t=e.arr.sort(((t,o)=>r.compare(t[e.key],o[e.key])));return e.desc?t.reverse():t}if(e.dateSortFromFrontmatter){const r=e.arr.sort(((r,t)=>new Date(r[e.key]).valueOf()-new Date(t[e.key]).valueOf()));return e.desc?r.reverse():r}if(e.dateSortFromTextWithPrefix){const r=/^[0-9]{4}-[0-9]{2}-[0-9]{2}/g,t=e.arr.sort(((t,o)=>{const n=t[e.key].split(r)?.[0],a=o[e.key].split(r)?.[0];return new Date(n).valueOf()-new Date(a).valueOf()}));return e.desc?t.reverse():t}return e.arr.sort(((r,t)=>e.desc?r[e.key]>t[e.key]?-1:r[e.key]<t[e.key]?1:0:r[e.key]<t[e.key]?-1:r[e.key]>t[e.key]?1:0))}static deepDeleteKey(e,r){"object"==typeof e&&null!==e&&(Object.hasOwn(e,r)&&delete e[r],Object.keys(e).forEach((t=>{"object"==typeof e[t]&&l.deepDeleteKey(e[t],r)})))}static removePrefixFromTitleAndLink(e,r){const t=e.length;for(let o=0;o<t;o+=1){const t=e[o];for(let e=0;e<Object.keys(t).length;e+=1){const o=Object.keys(t)[e];if("text"===o){if(r.prefixSeparator instanceof RegExp||-1!==t[o].indexOf(r.prefixSeparator)){const e=t[o].split(r.prefixSeparator);e.shift(),t[o]=e.join(r.prefixSeparator)}}else"items"===o&&(t[o]=l.removePrefixFromTitleAndLink(t[o],r))}}return e}static isTrueMinimumNumberOfTimes(e,r=1){const t=e.length;let o=0;for(let r=0;r<t;r+=1)"boolean"==typeof e[r]&&e[r]&&(o+=1);return o>=r}}export{l as VitePressSidebar};export const{generateSidebar:generateSidebar}=l;