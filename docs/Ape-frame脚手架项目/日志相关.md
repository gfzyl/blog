# 日志相关

普通的直接引入Sl4j有点慢，异步方式会更快，且主要是不阻塞主要的工作，引用AOP切面编程

### 异步日志配合AOP切面

以前鸡翅那个项目里头，日志信息的打印都是每个方法下面都要打印一些日志，而这种代码是固定的占行数的，而且还存在规范问题，如果用aop的方法去写，只要用切入表达式匹配方法，就可以获取方法签名、方法名、入参、出参，很方便统一的打印，减少工作量

![](./../%E9%B8%A1%E7%BF%85Club%E9%A1%B9%E7%9B%AE/1%E4%B8%80%E6%9C%9F/%E7%9F%A5%E8%AF%86/aop%E5%88%87%E9%9D%A2%E6%88%AA%E5%BE%97%E7%9A%84%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA.jpg)

做法：

```java
package com.york.log;

import com.google.gson.Gson;
import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Pointcut;
import org.aspectj.lang.reflect.MethodSignature;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.stereotype.Component;

/**
 * @author York
 * @className LogAspect
 * @date 2024/7/30
 * @description aop切面截取日志信息
 */
@Aspect
@Slf4j
@Component
@ConditionalOnProperty(name = {"log.aspect.enable"}, havingValue = "true", matchIfMissing = true)
public class LogAspect {


    // 对Controller和Service设置切点
    @Pointcut("execution(* com.york.*.controller.*Controller.*(..)) || execution(* com.york.*.service.*Service.*(..))")
    public void pointCut() {
    }

    /**
     * 环绕通知
     * @param pjp
     * @return
     * @throws Throwable
     */
    @Around("pointCut()")
    public Object around(ProceedingJoinPoint pjp) throws Throwable {
        // 1.获取请求参数
        Object[] reqArgs = pjp.getArgs();
        String req = new Gson().toJson(reqArgs);
        // 2.获取方法签名，即可获取方法的类名和方法名
        MethodSignature methodSignature = (MethodSignature) pjp.getSignature();
        String methodName = methodSignature.getDeclaringType().getName() + "."
                + methodSignature.getName();
        log.info("method:{},req:{}", methodName, req);
        long startTime = System.currentTimeMillis();
        // 切面需要抛出异常，不能try-catch，不然相当于将业务方法所有异常给捕获了
        Object responseObj = pjp.proceed();
        String resp = new Gson().toJson(responseObj);
        long endTime = System.currentTimeMillis();
        log.info("method:{},resp:{}", methodName, resp);
        log.info("method:{},costTime:{}", methodName, endTime - startTime);
        // 之前无返回，导致获取完数据被日志切面截胡，导致返回为null
        return responseObj;
    }
}
```

又配合了yml中的配置，实现用户选择性开关

```yml
# 自定义日志信息配置，利用aop切面输出controller和service的入参即出参
log:
  aspect:
    enable: true

```
